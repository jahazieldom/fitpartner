{% extends "core/base.html" %}

{% block panel_header %}
<div class="page-header d-print-none text-white" aria-label="Page header">
    <div class="container-xl">
      <div class="row g-2 align-items-center">
        <div class="col">
          <!-- Page pre-title -->
          <h2 class="page-title">{{ title }}</h2>
          <div class="page-pretitle">Administra las clases que ofreces a tus clientes</div>
        </div>
        <!-- Page title actions -->
        <div class="col-auto ms-auto d-print-none">
          <div class="btn-list">
            <a href="{% url 'activities:activity' %}" class="btn btn-primary btn-5 d-none d-sm-inline-block">
              <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-2">
                <path d="M12 5l0 14"></path>
                <path d="M5 12l14 0"></path>
              </svg>
              Agregar nueva clase
            </a>
          </div>
          <!-- BEGIN MODAL -->
          <!-- END MODAL -->
        </div>
      </div>
    </div>
  </div>
{% endblock panel_header %}

{% block content %}
  <div class="row row-cards">
    <div class="col-12">
      
      {% if not list.object_list %}
        {% include "utils/empty_state.html" with create_url=crear_cliente_url %}
      {% else %}
        <div class="card">
          <div class="card-table">
            <div class="card-header">
              <div class="row w-full">
                <div class="col-md-12">
                  <div class="ms-auto d-flex flex-wrap btn-list">
                    <form action="." class="ms-auto d-flex flex-wrap align-items-start btn-list">
                      <input type="hidden" name="f" value="1">

                      <div class="input-group input-group-flat w-auto">
                        <span class="input-group-text">
                          <!-- Download SVG icon from http://tabler.io/icons/icon/search -->
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
                            <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path>
                            <path d="M21 21l-6 -6"></path>
                          </svg>
                        </span>
                        {{ filtro_form.q }}
                        {{ filtro_form.errors }}
                        <span class="input-group-text">
                          <kbd>ctrl + K</kbd>
                        </span>
                      </div>

                      <div class="input-group input-group-flat w-auto">
                        <span class="input-group-text px-2">Elem. por página</span>
                        {{ filtro_form.page_size }}
                      </div>

                      <button type="submit" class="btn btn-outline-primary btn-icon">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-filter"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z" /></svg>
                      </button>

                      {% if request.GET.f %}
                      <a href="{{ request.path }}" class="btn btn-danger btn-icon" data-bs-toggle="tooltip" title="Limpiar filtros">
                      <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-filter-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13.758 19.414l-4.758 1.586v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v1.5" /><path d="M22 22l-5 -5" /><path d="M17 22l5 -5" /></svg>
                      </a>
                      {% endif %}
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div id="advanced-table">
              <div class="table-responsive">
                <table class="table table-vcenter table-selectable">
                  <thead>
                    <tr>
                      <th>Estatus</th>
                      <th>Nombre</th>
                      <th>Días de la semana</th>
                      <th>Horario</th>
                      <th>Capacidad</th>
                      <th>Instructor</th>
                      <th>Fecha de creación</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody class="table-tbody">
                    {% for obj in list.object_list %}
                    <tr>
                      <td class="sort-status">
                        {% if obj.is_active %}
                        <span class="badge bg-success-lt">Activa</span>
                        {% else %}
                        <span class="badge bg-danger-lt">Inactiva</span>
                        {% endif %}
                      </td>
                      <td class="fw-bold">
                        
                        {% if obj.color_rgb %}
                        <span style="color: {{obj.color_rgb}}">{{ obj.name }}</span>  
                        {% else %}
                        {{ obj.name }}
                        {% endif %}
                          
                      </td>
                      <td>{{ obj.get_week_days }}</td>
                      <td><i class="lucide lucide-{{ obj.time_icon }}"></i> {{ obj.time_icon }} {{ obj.start_time }}</td>
                      <td>{{ obj.capacity }}</td>
                      <td>{{ obj.instructor|default:"" }}</td>
                      <td>{{ obj.created_at }}</td>
                      <td>
                        <div class="btn-list flex-nowrap justify-content-end">
                          <a href="#" class="activity-session-modal" data-url="{% url 'activities:get_activity_session_form' obj.pk %}"> Duplicar</a>
                          <a href="{% url 'activities:activity' obj.id %}"> Editar</a>
                          <a data-confirm="¿Estás seguro que deseas eliminar este registro?" class="text-danger" href="{% url 'activities:delete_activity' obj.id %}"> Eliminar</a>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}  
                  </tbody>
                </table>
              </div>
              <div class="card-footer">
              {% include 'utils/pagination.html' %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="modal modal-blur fade rounded" id="modal_activity_session_form" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Duplicar clase</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        <div class="modal-body">
          <div id="id_activity_session_form"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

document.addEventListener('DOMContentLoaded', function () {
  document.body.addEventListener('click', async function (event) {
    const target = event.target.closest('.activity-session-modal');

    if (target) {
      event.preventDefault();  // Evita el salto por href="#"
      const url = target.getAttribute('data-url');

      try {
        const response = await fetch(url, {
          headers: {
            // 'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
          },
        });

        if (!response.ok) throw new Error('Error en la respuesta');

        const data = await response.json(); // Se espera JSON con una clave `html`
        document.getElementById('id_activity_session_form').innerHTML = data.html;
        const modalEl = document.getElementById('modal_activity_session_form');
        const bsModal = new tabler.bootstrap.Modal(modalEl);

        document.querySelectorAll('#id_activity_session_form .datepicker-default').forEach(function(el) {
          new Litepicker({
            element: el,
            format: 'DD/MM/YYYY',
            lang: 'es-MX',
            autoApply: true,
            singleMode: true,
            setup: (picker) => {
              const input = picker.options.element;
              input.addEventListener('blur', () => {
                if (!input.value.trim()) {
                  picker.clearSelection();
                }
              })
            },
            buttonText: {
              previousMonth: `<!-- Download SVG icon from http://tabler.io/icons/icon/chevron-left -->
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1"><path d="M15 6l-6 6l6 6" /></svg>`,
              nextMonth: `<!-- Download SVG icon from http://tabler.io/icons/icon/chevron-right -->
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1"><path d="M9 6l6 6l-6 6" /></svg>`,
            },
          });
        });



        bsModal.show();
      } catch (error) {
        console.error('Error al cargar el formulario:', error);
        alert('Hubo un problema al cargar el formulario.');
      }
    }
  });
});
</script>

{% endblock %}
